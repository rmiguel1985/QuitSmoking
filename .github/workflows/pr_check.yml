name: PR Check

on:
  pull_request:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  build-and-check:
    name: Build & Verify (Android)
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      # --- Checkout Repository ---
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- JDK Setup ---
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'
          cache: 'gradle'

      # --- Validate Gradle Wrapper ---
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      # --- Gradlew Permissions ---
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # --- 1. Create Build Config Variables ---
      - name: Create local.properties
        run: |
          echo "isDebugBuild=true" >> local.properties
          echo "appVersion=1.0.0" >> local.properties

      # --- 2. Run Tests ---
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest

      # --- 3. Build APK ---
      - name: Build Android Debug APK
        run: ./gradlew assembleDebug

      # --- 3.1 Upload APK ---
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: composeApp/build/outputs/apk/debug/composeApp-debug.apk
          retention-days: 5

      # --- 4. Check Android Lint ---
      - name: Run Android Lint
        run: ./gradlew lintDebug

      # --- 5. Generate Kover XML ---
      - name: Generate Kover XML
        run: ./gradlew koverXmlReport

      # --- 6. Create Coverage Badge JSON ---
      - name: Create coverage badge JSON
        run: |
          COVERAGE_FILE="composeApp/build/reports/kover/xml/report.xml"
          COVERED=$(grep -oPm1 "(?<=<counter type=\"INSTRUCTION\" covered=\")[^\"]+" "$COVERAGE_FILE")
          MISSED=$(grep -oPm1 "(?<=<counter type=\"INSTRUCTION\" missed=\")[^\"]+" "$COVERAGE_FILE")
          TOTAL=$((COVERED + MISSED))
          PERCENT=$((100 * COVERED / TOTAL))
          mkdir -p coverage
          echo "{ \"schemaVersion\": 1, \"label\": \"coverage\", \"message\": \"${PERCENT}%\", \"color\": \"green\" }" > coverage/coverage.json

      # --- 7. Upload Badge JSON as artifact ---
      - name: Upload Coverage Badge
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: coverage/coverage.json
          retention-days: 5

      # --- 8. Push badge JSON to badges branch ---
      - name: Push badge to badges branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch
          git checkout badges || git checkout -b badges
          mv coverage/coverage.json coverage.json
          git add coverage.json
          git commit -m "Update coverage badge" || echo "No changes"
          git push origin badges

      # --- 9. Upload Test & Lint Results (on failure) ---
      - name: Upload Test & Lint Results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/reports/tests/
            **/build/reports/lint-results-debug.html